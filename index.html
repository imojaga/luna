<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æœˆæ˜Ÿåº§è¾²æ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆæœ¬æ ¼é‹ç”¨ï¼‰</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background:#f4f6f8; color:#243447; padding:20px; }
    h1 { text-align:center; margin:0 0 6px; }
    .subtitle { text-align:center; color:#5a6b7a; margin-bottom:14px; }
    form { text-align:center; margin:12px 0 16px; }
    input[type="number"] { padding:6px 8px; margin:0 6px; width:96px; }
    button { padding:6px 14px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { border:1px solid #dfe6ee; padding:8px 10px; text-align:center; }
    th { background:#324960; color:#fff; font-weight:600; }
    tbody tr:nth-child(even) { background:#f9fbfd; }
    .phase { font-size:18px; }
    .earth { background:#e6f6ea; }
    .water { background:#e7f0fb; }
    .air   { background:#fff7da; }
    .fire  { background:#ffe8e4; }
    .transition { background:#f2f4f6; color:#333; }
    .note { margin-top:10px; font-size:12px; color:#5f6a72; }
    @media print {
      body { background:#fff; padding:0; }
      a, .note { color:#000; text-decoration:none; }
    }
  </style>
</head>
<body>
  <h1>æœˆæ˜Ÿåº§è¾²æ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
  <div class="subtitle">å¹´ã¨æœˆã‚’å…¥åŠ› â†’ æœˆé½¢ãƒ»æœˆç›¸ãƒ»æœˆæ˜Ÿåº§ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆJSTåŸºæº–ï¼‰</div>

  <form id="scheduleForm">
    <label>å¹´: <input type="number" id="year" min="1900" max="2100" required></label>
    <label>æœˆ: <input type="number" id="month" min="1" max="12" required></label>
    <button type="submit">ç”Ÿæˆã™ã‚‹</button>
  </form>

  <div id="output"></div>

  <script>
    // ========= åŸºæœ¬å®šæ•° =========
    const SYNODIC_MONTH = 29.530588853; // æœ”æœ›æœˆï¼ˆæ—¥ï¼‰
    const JD_UNIX_EPOCH = 2440587.5;    // 1970-01-01T00:00:00Z ã®JD
    const JD_J2000 = 2451545.0;         // 2000-01-01 12:00 TT è¿‘ä¼¼
    const JD_REF_NEWM = 2451550.1;      // 2000-01-06 18:14 è¿‘å‚ã®æ–°æœˆJDï¼ˆè¿‘ä¼¼ï¼‰

    const SIGNS = ["ç‰¡ç¾Šåº§","ç‰¡ç‰›åº§","åŒå­åº§","èŸ¹åº§","ç…å­åº§","ä¹™å¥³åº§","å¤©ç§¤åº§","è åº§","å°„æ‰‹åº§","å±±ç¾Šåº§","æ°´ç“¶åº§","é­šåº§"];
    const ELEMENT_CLASS = { "ç‰¡ç¾Šåº§":"fire", "ç‰¡ç‰›åº§":"earth", "åŒå­åº§":"air", "èŸ¹åº§":"water", "ç…å­åº§":"fire", "ä¹™å¥³åº§":"earth", "å¤©ç§¤åº§":"air", "è åº§":"water", "å°„æ‰‹åº§":"fire", "å±±ç¾Šåº§":"earth", "æ°´ç“¶åº§":"air", "é­šåº§":"water" };
    const ELEMENT_JP = { fire:"ç«", earth:"åœ°", air:"é¢¨", water:"æ°´" };
    const PHASE_EMOJI = ["ğŸŒ‘","ğŸŒ’","ğŸŒ“","ğŸŒ”","ğŸŒ•","ğŸŒ–","ğŸŒ—","ğŸŒ˜"];

    // ========= æ—¥ä»˜ã¨æ™‚åˆ»ï¼ˆJSTï¼‰ãƒ˜ãƒ«ãƒ‘ =========
    // JSTã®ç‰¹å®šæ—¥æ™‚ï¼ˆå¹´ãƒ»æœˆãƒ»æ—¥ãƒ»æ™‚ï¼‰ã‚’UTCã®Dateã¨ã—ã¦ç”Ÿæˆï¼ˆè¨ˆç®—ã¯UTCã§è¡Œã†ï¼‰
    function dateJSTasUTC(y, m, d, hJst = 12, min = 0) {
      // JST = UTC+9 â†’ UTC = JST - 9h
      return new Date(Date.UTC(y, m - 1, d, hJst - 9, min, 0));
    }

    // ========= JDï¼ˆãƒ¦ãƒªã‚¦ã‚¹æ—¥ï¼‰ =========
    function toJulianDay(dateUtc) {
      return dateUtc.getTime() / 86400000 + JD_UNIX_EPOCH;
    }

    // ========= è§’åº¦ãƒ˜ãƒ«ãƒ‘ =========
    const D2R = Math.PI / 180;
    const R2D = 180 / Math.PI;
    function norm360(deg) {
      return (deg % 360 + 360) % 360;
    }

    // ========= æœˆé½¢ãƒ»æœˆç›¸ =========
    function moonAgeDays(jd) {
      const days = (jd - JD_REF_NEWM) % SYNODIC_MONTH;
      return (days + SYNODIC_MONTH) % SYNODIC_MONTH;
    }
    function phaseEmoji(age) {
      // 8åŒºåˆ†ï¼šå¢ƒç•Œã‚’æœ”æœ›æœˆ/16ã ã‘ãšã‚‰ã—ã¦ä¸¸ã‚ã‚‹
      const bin = Math.floor(((age + SYNODIC_MONTH / 16) / (SYNODIC_MONTH / 8)) % 8);
      return PHASE_EMOJI[bin];
    }

    // ========= å¤ªé™½ã®å¹³å‡è¿‘ç‚¹é›¢è§’ï¼ˆMï¼‰è¿‘ä¼¼ =========
    function sunMeanAnomaly(T) {
      // Meeusè¿‘ä¼¼ï¼šMï¼ˆå¤ªé™½ï¼‰[deg]
      let M = 357.5291092 + 35999.0502909 * T - 0.0001536 * T * T + (T * T * T) / 24490000;
      return norm360(M);
    }

    // ========= æœˆã®é»„çµŒï¼ˆä½æ¬¡è¿‘ä¼¼ï¼‰ =========
    function moonEclipticLongitude(jd) {
      // ãƒ¦ãƒªã‚¦ã‚¹ä¸–ç´€
      const T = (jd - JD_J2000) / 36525;

      // å¹³å‡é»„çµŒ L'ã€æœˆã®å¹³å‡è¿‘ç‚¹é›¢è§’ M'ã€å¤ªé™½ã®å¹³å‡è¿‘ç‚¹é›¢è§’ Mã€é›¢è§’ Dã€ç·¯åº¦å¼•æ•° Fï¼ˆåº¦ï¼‰
      let Lp = 218.3164477 + 481267.88123421 * T - 0.0015786 * T*T + (T*T*T)/538841 - (T*T*T*T)/65194000;
      let Mp = 134.9633964 + 477198.8675055 * T + 0.0087414 * T*T + (T*T*T)/69699 - (T*T*T*T)/14712000;
      let M  = 357.5291092 + 35999.0502909 * T - 0.0001536 * T*T + (T*T*T)/24490000;
      let D  = 297.8501921 + 445267.1114034 * T - 0.0018819 * T*T + (T*T*T)/545868 - (T*T*T*T)/113065000;
      let F  = 93.2720950  + 483202.0175233 * T - 0.0036539 * T*T - (T*T*T)/3526000 + (T*T*T*T)/863310000;

      Lp = norm360(Lp); Mp = norm360(Mp); M = norm360(M); D = norm360(D); F = norm360(F);

      // ä¸»è¦é …ã®ã¿ï¼ˆä½æ¬¡ï¼‰ã§é»„çµŒÎ»ã‚’è¿‘ä¼¼ï¼ˆåº¦ï¼‰
      const lambda = Lp
        + 6.289 * Math.sin(Mp * D2R)            // +6.289Â° sin M'
        + 1.274 * Math.sin((2*D - Mp) * D2R)    // +1.274Â° sin(2D - M')
        + 0.658 * Math.sin((2*D) * D2R)         // +0.658Â° sin 2D
        + 0.214 * Math.sin((2*Mp) * D2R)        // +0.214Â° sin 2M'
        - 0.186 * Math.sin(M * D2R)             // -0.186Â° sin Mï¼ˆå¤ªé™½é …ï¼‰
        - 0.114 * Math.sin((2*F) * D2R);        // -0.114Â° sin 2Fï¼ˆå…‰è¡Œå·®çš„è£œæ­£å«ã‚€è¿‘ä¼¼ï¼‰

      return norm360(lambda);
    }

    // ========= æœˆæ˜Ÿåº§ï¼ˆãƒˆãƒ­ãƒ”ã‚«ãƒ«ï¼‰ =========
    function moonSignFromLongitude(lambda) {
      const idx = Math.floor(lambda / 30) % 12; // 0=ç‰¡ç¾Šåº§
      return SIGNS[idx];
    }

    // ========= åŒæ—¥å†…ã®æ˜Ÿåº§åˆ‡æ›¿æ™‚åˆ»ã®æ¨å®š =========
    function findSignChangeJST(y, m, d) {
      // 00:00ã€œ23:59 JSTã§ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
      let prevSign = null;
      let changeHour = null;
      for (let h = 0; h <= 23; h++) {
        const jd = toJulianDay(dateJSTasUTC(y, m, d, h, 0));
        const sign = moonSignFromLongitude(moonEclipticLongitude(jd));
        if (prevSign && sign !== prevSign) {
          changeHour = h; // å‰ã®æ™‚é–“ã¨ã“ã®æ™‚é–“ã®é–“ã§å¤‰åŒ–
          break;
        }
        prevSign = sign;
      }
      if (changeHour === null) return null;

      // æ™‚åˆ»ã‚’10åˆ†å˜ä½â†’1åˆ†å˜ä½ã§2æ®µéšç²¾å¯†åŒ–
      let leftMin = (changeHour - 1 >= 0 ? changeHour - 1 : 0) * 60;
      let rightMin = changeHour * 60;
      let leftSign = moonSignFromLongitude(moonEclipticLongitude(toJulianDay(dateJSTasUTC(y, m, d, Math.floor(leftMin/60), leftMin%60))));
      for (let step of [10, 1]) {
        for (let t = leftMin; t <= rightMin; t += step) {
          const h = Math.floor(t / 60), min = t % 60;
          const jd = toJulianDay(dateJSTasUTC(y, m, d, h, min));
          const s = moonSignFromLongitude(moonEclipticLongitude(jd));
          if (s !== leftSign) {
            // å¤‰åŒ–ç›´å¾Œã«åˆ°é”
            rightMin = t;
            break;
          }
        }
        leftMin = Math.max(rightMin - step, 0);
        leftSign = moonSignFromLongitude(moonEclipticLongitude(toJulianDay(dateJSTasUTC(y, m, d, Math.floor(leftMin/60), leftMin%60))));
      }
      const H = Math.floor(rightMin / 60);
      const M = rightMin % 60;
      return { H, M };
    }

    // ========= æ¨å¥¨ä½œæ¥­ï¼ˆã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆï¼‹æº€ã¡æ¬ ã‘è€ƒæ…®ï¼‰ =========
    function recommendWork(elementClass, age) {
      const waxing = age < SYNODIC_MONTH / 2; // æ–°æœˆâ†’æº€æœˆï¼šæº€ã¡æœŸ
      let core = "";
      switch (elementClass) {
        case "earth": core = "æ ¹èœã®ç¨®ã¾ããƒ»æ¤ãˆä»˜ã‘ã€åœŸå£Œæ”¹è‰¯ã€å †è‚¥ä½œã‚Š"; break;
        case "water": core = "è‘‰ç‰©ã®ç¨®ã¾ããƒ»æ¤ãˆä»˜ã‘ã€æ°´ã‚„ã‚Šã€æŒ¿ã—æœ¨"; break;
        case "air":   core = "å‰ªå®šã€é€šæ°—æ€§æ”¹å–„ã€æ”¯æŸ±ç«‹ã¦ãƒ»èª˜å¼•"; break;
        case "fire":  core = "æœèœã®åç©«ã€ç—…å®³è™«å¯¾ç­–ã€è¿½è‚¥"; break;
      }
      let extra = "";
      const nearFull = Math.abs(age - SYNODIC_MONTH/2) < 0.7;
      const nearNew  = (age < 0.7) || (SYNODIC_MONTH - age < 0.7);
      if (nearFull) extra = "ï¼ˆæº€æœˆï¼šåç©«ãƒ»é¸åˆ¥ãƒ»æ°´åˆ†ç®¡ç†ï¼‰";
      else if (nearNew) extra = "ï¼ˆæ–°æœˆï¼šè¨ˆç”»è¦‹ç›´ã—ãƒ»ç•æ•´å‚™ãƒ»ç¨®å­æº–å‚™ï¼‰";
      else extra = waxing ? "ï¼ˆæº€ã¡æœŸï¼šåœ°ä¸Šéƒ¨ã®ç®¡ç†å¼·åŒ–ï¼‰" : "ï¼ˆæ¬ ã‘æœŸï¼šåœ°ä¸‹éƒ¨ã®å……å®Ÿãƒ»ä¿å­˜å‘ã‘åç©«ï¼‰";
      return core + " " + extra;
    }

    // ========= æœˆæ¬¡è¡¨ç”Ÿæˆ =========
    function generateSchedule(year, month) {
      const output = document.getElementById("output");
      const lastDay = new Date(year, month, 0).getDate(); // æœˆæœ«æ—¥

      let html = `<h2>${year}å¹´${month}æœˆã®æœˆæ˜Ÿåº§è¾²æ¥­ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>`;
      html += `<table><thead><tr>
        <th>æ—¥ä»˜</th><th>æœˆé½¢</th><th>æœˆç›¸</th><th>æœˆæ˜Ÿåº§</th><th>ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ</th><th>æ¨å¥¨ä½œæ¥­</th>
      </tr></thead><tbody>`;

      for (let d = 1; d <= lastDay; d++) {
        // åŸºæº–ã¯JSTæ­£åˆ
        const jdNoon = toJulianDay(dateJSTasUTC(year, month, d, 12, 0));
        const age = moonAgeDays(jdNoon);
        const emoji = phaseEmoji(age);

        // æœˆæ˜Ÿåº§ï¼ˆæ­£åˆï¼‰ã¨ã€æ—¥å†…åˆ‡æ›¿ãƒã‚§ãƒƒã‚¯
        const lambdaNoon = moonEclipticLongitude(jdNoon);
        const signNoon = moonSignFromLongitude(lambdaNoon);
        const elemClass = ELEMENT_CLASS[signNoon];

        // æ—¥å†…ã§å¤‰ã‚ã‚‹ã‹ï¼Ÿ
        const jd00 = toJulianDay(dateJSTasUTC(year, month, d, 0, 0));
        const jd23 = toJulianDay(dateJSTasUTC(year, month, d, 23, 59));
        const signStart = moonSignFromLongitude(moonEclipticLongitude(jd00));
        const signEnd   = moonSignFromLongitude(moonEclipticLongitude(jd23));

        let signCell = signNoon;
        if (signStart !== signEnd) {
          const t = findSignChangeJST(year, month, d);
          if (t) {
            signCell = `${signStart} â†’ ${signEnd} (${String(t.H).padStart(2,'0')}:${String(t.M).padStart(2,'0')})`;
          } else {
            signCell = `${signStart} â†’ ${signEnd}`;
          }
        }

        const elemForCell = (signStart !== signEnd) ? "transition" : elemClass;
        const elemLabel = (signStart !== signEnd)
          ? "åˆ‡æ›¿"
          : ELEMENT_JP[elemClass];

        const work = recommendWork(elemClass, age);

        html += `<tr>
          <td>${month}/${d}</td>
          <td>${age.toFixed(1)}</td>
          <td class="phase">${emoji}</td>
          <td>${signCell}</td>
          <td class="${elemForCell}">${elemLabel}</td>
          <td>${work}</td>
        </tr>`;
      }

      html += `</tbody></table>
      <div class="note">
        æ³¨1ï¼šè¨ˆç®—ã¯è¿‘ä¼¼å¼ï¼ˆMeeusã®ä¸»è¦é …ã«ã‚ˆã‚‹æœˆé»„çµŒã€å›ºå®šæœ”æœ›æœˆé•·ï¼‰ã«åŸºã¥ããŸã‚ã€å®Ÿéš›ã®å¤©æ–‡æš¦ã¨æ•°åˆ†ã€œæ•°æ™‚é–“ã®ãšã‚ŒãŒç”Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br/>
        æ³¨2ï¼šæ˜Ÿåº§åˆ‡æ›¿æ™‚åˆ»ã¯JSTåŸºæº–ã®æ¦‚ç®—ã§ã™ã€‚é‹ç”¨ã§ã¯æ°—è±¡ãƒ»åœƒå ´æ¡ä»¶ã¨ä½µç”¨ã—ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚<br/>
        æ³¨3ï¼šç«¯æœ«ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®šãŒJSTã§ãªã„å ´åˆã€åˆ‡æ›¿æ™‚åˆ»ã®è¡¨ç¤ºã«ãšã‚ŒãŒå‡ºã¾ã™ï¼ˆæœ¬é‹ç”¨ã¯JSTæ¨å¥¨ï¼‰ã€‚
      </div>`;

      output.innerHTML = html;
    }

    // ========= ãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ =========
    document.getElementById("scheduleForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const year = parseInt(document.getElementById("year").value, 10);
      const month = parseInt(document.getElementById("month").value, 10);
      if (!year || !month) return;
      generateSchedule(year, month);
    });

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ç¾åœ¨å¹´æœˆã«ã‚»ãƒƒãƒˆ
    (function initDefaultYM() {
      const now = new Date();
      document.getElementById("year").value = now.getFullYear();
      document.getElementById("month").value = now.getMonth() + 1;
    })();
  </script>
</body>
</html>
